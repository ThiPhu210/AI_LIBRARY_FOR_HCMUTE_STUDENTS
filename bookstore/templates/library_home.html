{% extends 'publisher/base.html' %}
{% load static %}
{% comment %} {% block title %}Thư Viện HCMUTE{% endblock %} {% endcomment %}

{% block content %}
<!-- Add favicon links -->
<link rel="icon" type="image/png" sizes="32x32" href="{% static 'assets/img/favicon-32x32.png' %}">
<link rel="icon" type="image/png" sizes="16x16" href="{% static 'assets/img/favicon-16x16.png' %}">
<link rel="apple-touch-icon" sizes="180x180" href="{% static 'assets/img/apple-touch-icon.png' %}">
<link rel="manifest" href="{% static 'assets/img/site.webmanifest' %}">

<style>
    .container-fluid {
        padding: 20px;
        background: #f8f9fa;
    }
    
    .list-group {
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        overflow: hidden;
        background: white;
    }
    
    .list-group-item {
        border: none;
        padding: 15px 20px;
        transition: all 0.3s ease;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .list-group-item:first-child {
        border-radius: 15px 15px 0 0;
    }
    
    .list-group-item:last-child {
        border-radius: 0 0 15px 15px;
        border-bottom: none;
    }
    
    .list-group-item.active {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        border: none;
    }
    
    .list-group-item a {
        color: #2c3e50;
        transition: all 0.3s ease;
        text-decoration: none;
        font-weight: 500;
    }
    
    .list-group-item a:hover {
        color: #3498db;
        transform: translateX(5px);
    }
    
    .list-group-item.active a {
        color: white;
    }
    
    .list-group-item.bg-light {
        background: #f8f9fa !important;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #e9ecef;
    }
    
    .card {
        border: none;
        border-radius: 15px;
        transition: all 0.3s ease;
        height: 100%;
        background: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .card-img-top {
        border-radius: 15px 15px 0 0;
        height: 250px;
        object-fit: cover;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .card-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 2.8em;
        line-height: 1.4;
    }
    
    .btn-group {
        gap: 8px;
    }
    
    .btn-outline-primary {
        color: #3498db;
        border-color: #3498db;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-outline-success {
        color: #2ecc71;
        border-color: #2ecc71;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover, .btn-outline-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        color: white;
    }
    
    .btn-outline-primary:hover {
        background: #3498db;
    }
    
    .btn-outline-success:hover {
        background: #2ecc71;
    }
    
    .alert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        padding: 1rem 1.5rem;
    }
    
    h2, h3 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 2rem;
        position: relative;
        padding-bottom: 15px;
        font-size: 1.8rem;
    }
    
    h2:after, h3:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 60px;
        height: 4px;
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        border-radius: 4px;
    }
    
    .text-muted {
        color: #7f8c8d !important;
    }
    
    .discover-section {
        margin-top: 4rem;
        padding-top: 3rem;
        border-top: 2px solid #e9ecef;
    }
    
    .discover-card {
        height: 100%;
        transition: all 0.3s ease;
    }
    
    .discover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .discover-card img {
        height: 220px;
        object-fit: cover;
    }
    
    .discover-card .card-title {
        font-size: 1.1rem;
        margin-bottom: 1rem;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .discover-card .card-text {
        margin-bottom: 1.2rem;
    }
    
    .discover-card .card-text small {
        display: block;
        margin-bottom: 0.5rem;
        color: #7f8c8d;
    }
    
    .discover-card .card-text small i {
        width: 20px;
        color: #3498db;
    }
    
    .discover-card .btn-group {
        margin-top: 0.5rem;
    }
    
    .discover-card .btn {
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .row {
        margin: 0 -10px;
    }
    
    .col-md-3, .col-md-2 {
        padding: 0 10px;
    }
    
    .mb-4 {
        margin-bottom: 2rem !important;
    }
    
    .card-text small {
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .card-text small i {
        width: 20px;
        color: #3498db;
        margin-right: 8px;
    }

    .list-group-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }

    .btn i {
        margin-right: 6px;
    }

    h2 i, h3 i {
        margin-right: 10px;
    }

    /* Chatbot styles */
    .chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 450px;
        height: 600px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .chatbot-header {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        padding: 15px 20px;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
    }

    .chatbot-header h5 {
        margin: 0;
        font-weight: 500;
        font-size: 1.2rem;
    }

    .chatbot-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #fff;
    }

    .chatbot-messages {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .chatbot-message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 10px;
    }

    .chatbot-message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        border-bottom-right-radius: 5px;
    }

    .chatbot-message.bot {
        align-self: flex-start;
        background: #f0f2f5;
        color: #1a237e;
        border-bottom-left-radius: 5px;
    }

    .chatbot-input {
        padding: 15px;
        background: white;
        border-top: 1px solid #e0e0e0;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
    }

    .chatbot-input form {
        display: flex;
        gap: 10px;
    }

    .chatbot-input input {
        flex: 1;
        border: 1px solid #e0e0e0;
        border-radius: 25px;
        padding: 12px 20px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .chatbot-input input:focus {
        border-color: #1a237e;
        box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1);
        outline: none;
    }

    .chatbot-input button {
        border: none;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .chatbot-input button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(26, 35, 126, 0.3);
    }

    .chatbot-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .chatbot-toggle:hover {
        transform: scale(1.1);
    }

    .chatbot-toggle i {
        font-size: 24px;
    }

    .chatbot-container.hidden {
        transform: translateY(120%);
    }

    /* Custom scrollbar for chatbot */
    .chatbot-body::-webkit-scrollbar {
        width: 6px;
    }

    .chatbot-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .chatbot-body::-webkit-scrollbar-thumb {
        background: #1a237e;
        border-radius: 10px;
    }

    .chatbot-body::-webkit-scrollbar-thumb:hover {
        background: #0d47a1;
    }

    .message-content {
        line-height: 1.5;
    }

    .message-content b {
        font-weight: 600;
    }

    .message-content br {
        margin-bottom: 8px;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1a237e;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <div class="row" style="padding-top: 70px">
        <!-- Sidebar -->
        <div class="col-md-2">
            <div class="list-group">
                <a href="{% url 'library_home' %}" class="list-group-item list-group-item-action {% if not selected_department and not view_type %}active{% endif %}">
                    <i class="fas fa-th-large me-2"></i>Tất Cả
                </a>
                <div class="list-group-item">
                    <a href="{% url 'library_home' %}?view=recommended" class="text-decoration-none {% if view_type == 'recommended' %}text-primary fw-bold{% endif %}">
                        <i class="fas fa-star me-2"></i>Sách gợi ý
                    </a>
                </div>
                <div class="list-group-item">
                    <a href="{% url 'library_home' %}?view=all" class="text-decoration-none {% if view_type == 'all' %}text-primary fw-bold{% endif %}">
                        <i class="fas fa-book me-2"></i>Tất cả sách
                    </a>
                </div>
                <div class="list-group-item bg-light">
                    <i class="fas fa-university me-2"></i>Khoa
                </div>
                {% for dept in departments %}
                <a href="{% url 'library_home' %}?department={{ dept.id }}" 
                   class="list-group-item list-group-item-action {% if selected_department.id == dept.id %}active{% endif %}">
                    <i class="fas fa-graduation-cap me-2"></i>{{ dept.name }}
                </a>
                {% endfor %}
            </div>
        </div>
        
        <!-- Main content -->
        <div class="col-md-10">
            {% if selected_department %}
            <h2><i class="fas fa-book-open me-2"></i>Sách của khoa {{ selected_department.name }}</h2>
            {% elif view_type == 'recommended' %}
            <h2><i class="fas fa-star me-2"></i>Sách được gợi ý cho bạn</h2>
            {% elif view_type == 'all' %}
            <h2><i class="fas fa-books me-2"></i>Tất cả sách</h2>
            {% else %}
            <h2><i class="fas fa-star me-2"></i>Sách được gợi ý cho bạn</h2>
            {% endif %}
            
            <div class="row">
                {% for book in recommend_books %}
                <div class="col-md-3 mb-4">
                    <div class="card shadow-sm">
                        {% if book.cover %}
                        <img src="{{ book.cover.url }}" class="card-img-top" alt="{{ book.title }}">
                        {% else %}
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center">
                            <i class="fas fa-book fa-3x text-muted"></i>
                        </div>
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ book.title }}</h5>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-user-edit me-1"></i>Tác giả: {{ book.author }}
                                </small>
                            </p>
                            <p class="card-text">
                                <small class="text-muted">
                                    <i class="fas fa-university me-1"></i>
                                    {% if book.department %}
                                    Khoa: {{ book.department.name }}
                                    {% else %}
                                    Chưa phân loại
                                    {% endif %}
                                </small>
                            </p>
                            {% if book.description %}
                            <p class="card-text small text-muted">
                                <i class="fas fa-info-circle me-1"></i>{{ book.description|truncatechars:100 }}
                            </p>
                            {% endif %}
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                {% if book.pdf %}
                                <div class="btn-group">
                                    <a href="{{ book.pdf.url }}" class="btn btn-outline-primary" target="_blank">
                                        <i class="fas fa-eye me-1"></i>Xem
                                    </a>
                                    <a href="{{ book.pdf.url }}" download class="btn btn-outline-success">
                                        <i class="fas fa-download me-1"></i>Tải xuống
                                    </a>
                                </div>
                                {% else %}
                                <span class="text-muted small">
                                    <i class="fas fa-exclamation-circle me-1"></i>Không có file PDF
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if selected_department %}
                            Không có sách nào trong khoa này.
                        {% elif view_type == 'all' %}
                            Không có sách nào trong thư viện.
                        {% else %}
                            Không có sách được gợi ý. Hãy tương tác với sách để nhận gợi ý cá nhân hóa!
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if not selected_department and not view_type %}
            <div class="discover-section">
                <h3><i class="fas fa-compass me-2"></i>Khám phá thêm sách</h3>
                <div class="row">
                    {% for book in discover_books %}
                    <div class="col-md-3 mb-4">
                        <div class="card discover-card shadow-sm">
                            {% if book.cover %}
                            <img src="{{ book.cover.url }}" class="card-img-top" alt="{{ book.title }}">
                            {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center">
                                <i class="fas fa-book fa-2x text-muted"></i>
                            </div>
                            {% endif %}
                            <div class="card-body">
                                <h6 class="card-title">{{ book.title }}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-user-edit me-1"></i>Tác giả: {{ book.author }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-university me-1"></i>
                                        {% if book.department %}
                                        Khoa: {{ book.department.name }}
                                        {% else %}
                                        Chưa phân loại
                                        {% endif %}
                                    </small>
                                </p>
                                {% if book.pdf %}
                                <div class="btn-group w-100">
                                    <a href="{{ book.pdf.url }}" class="btn btn-outline-primary" target="_blank">
                                        <i class="fas fa-eye me-1"></i>Xem
                                    </a>
                                    <a href="{{ book.pdf.url }}" download class="btn btn-outline-success">
                                        <i class="fas fa-download me-1"></i>Tải xuống
                                    </a>
                                </div>
                                {% else %}
                                <span class="text-muted small">
                                    <i class="fas fa-exclamation-circle me-1"></i>Không có file PDF
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Chatbot Toggle Button -->
<div class="chatbot-toggle" id="chatbotToggle">
    <i class="fas fa-comments"></i>
</div>

<!-- Chatbot Container -->
<div class="chatbot-container hidden" id="chatbotContainer">
    <div class="chatbot-header" id="chatbotHeader">
        <div class="img-cont2">              
            <img src="https://img.icons8.com/?size=100&id=L3uh0mNuxBXw&format=png&color=FFFFFF" alt="bot" width="40" height="40" class="rounded-circle">
            <span class="online-circle3"></span>  
        </div>
        <h5>Trợ lý ảo HCMUTE</h5>
    </div>
    <div class="chatbot-body">
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chatbot-message bot">
                Xin chào! Tôi là trợ lý ảo của thư viện HCMUTE. Tôi có thể giúp gì cho bạn?
            </div>
        </div>
    </div>
    <div class="chatbot-input">
        <form id="chatbotForm">
            {% csrf_token %}
            <input type="text" placeholder="Nhập tin nhắn của bạn..." id="chatbotInput">
            <button type="submit">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotContainer = document.getElementById('chatbotContainer');
    const chatbotHeader = document.getElementById('chatbotHeader');
    const chatbotForm = document.getElementById('chatbotForm');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotMessages = document.getElementById('chatbotMessages');

    const processMessageContent = (content) => {
        content = content.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        content = content.replace(/(\d+\. )/g, '<br>$1');
        content = content.replace(/\*\s?/g, '<br>- ');
        content = content.replace(/([.:])\s*-\s+/g, '$1<br>- ');
        return content;
    };

    // Load chat history when opening mini chatbot
    async function loadChatHistory() {
        try {
            const response = await fetch('/chatbot/');
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const historyMessages = doc.querySelectorAll('.messages-list .message');
            
            // Clear existing messages
            chatbotMessages.innerHTML = '';
            
            // Add history messages
            historyMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chatbot-message');
                messageDiv.classList.add(msg.classList.contains('sent') ? 'user' : 'bot');
                
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('message-content');
                contentDiv.innerHTML = processMessageContent(msg.querySelector('.message-content').textContent);
                
                messageDiv.appendChild(contentDiv);
                chatbotMessages.appendChild(messageDiv);
            });
            
            scrollToBottom();
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }

    // Toggle chatbot visibility
    chatbotToggle.addEventListener('click', async () => {
        chatbotContainer.classList.toggle('hidden');
        if (!chatbotContainer.classList.contains('hidden')) {
            await loadChatHistory();
        }
    });

    chatbotHeader.addEventListener('click', () => {
        chatbotContainer.classList.add('hidden');
    });

    // Handle form submission
    chatbotForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = chatbotInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, 'user');
        chatbotInput.value = '';

        try {
            const response = await fetch('/chatbot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'message': message,
                    'is_mini_chat': 'true'
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let botResponse = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const text = decoder.decode(value);
                botResponse += text;
                addMessage(botResponse, 'bot', true);
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại sau.', 'bot');
        }
    });

    function addMessage(text, type, isStreaming = false) {
        if (isStreaming) {
            // Update existing bot message if streaming
            const lastMessage = chatbotMessages.lastElementChild;
            if (lastMessage && lastMessage.classList.contains('bot')) {
                lastMessage.querySelector('.message-content').innerHTML = processMessageContent(text);
            } else {
                createNewMessage(text, type);
            }
        } else {
            createNewMessage(text, type);
        }
        scrollToBottom();
    }

    function createNewMessage(text, type) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chatbot-message', type);
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');
        contentDiv.innerHTML = processMessageContent(text);
        messageDiv.appendChild(contentDiv);
        chatbotMessages.appendChild(messageDiv);
    }

    function scrollToBottom() {
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
});
</script>
{% endblock %}